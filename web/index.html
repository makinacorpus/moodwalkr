<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<title>Routing</title>
	 <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
	 <link rel="stylesheet" href="http://medialize.github.com/jQuery-contextMenu/src/jquery.contextMenu.css" />
	<!--[if lte IE 8]>
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css" />
	<![endif]-->
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
	<script src="http://medialize.github.com/jQuery-contextMenu/src/jquery.ui.position.js"></script>
	<script src="http://medialize.github.com/jQuery-contextMenu/src/jquery.contextMenu.js"></script>
</head>

<body>
	<!-- Add Leaflet library -->
	<div id="map" style="height:600px;" ></div>
	<div id="routeLength"></div>
	<div id="routeTime"></div>
	<div id="responseTime"></div>
	<div id="profile">
		<input type="radio" name="profile" id="profileShortest" value="length" onclick="computeRoute()" checked/>Shortest path<br />
		<input type="radio" name="profile" id="profileActivity" value="cost_activity" onclick="computeRoute()" />Activity<br />
		<input type="radio" name="profile" id="profileActivity" value="cost_nature" onclick="computeRoute()" />Nature
	</div>
	<script type='text/javascript'>
		map = new L.Map('map');
		// create the tile layer with correct attribution
		var osmUrl='http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png';
		var osmAttrib='Carte <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png"> Données <a href="http://www.openstreetmap.org/copyright">© Contributeurs OpenStreetMap</a>';
		var subDomains = ['otile1','otile2','otile3','otile4'];
		var osm = new L.TileLayer(osmUrl, {minZoom: 3, maxZoom: 18, attribution: osmAttrib, subdomains: subDomains});	

		// Don't show the 'Powered by Leaflet' text	
		map.attributionControl.setPrefix('');

		// Start the map in Toulouse
		map.addLayer(osm);
		map.setView(new L.LatLng(43.6, 1.4),12);
		
<!--		// markerStart-->
<!--		var markerStart = null;-->
<!--		var latStart;-->
<!--		var lonStart;-->
<!--		map.on('click', function(e) {-->
<!--			if (markerStart == null) {-->
<!--				markerStart = L.marker(e.latlng);-->
<!--				markerStart.addTo(map);-->
<!--			} else {-->
<!--				markerStart.setLatLng(e.latlng);-->
<!--			};-->
<!--		latStart = markerStart.getLatLng().lat;-->
<!--		lonStart = markerStart.getLatLng().lng;-->
<!--		computeRoute()-->
<!--		});-->

<!--		-->
<!--		// markerStop-->
<!--		var markerStop = null;-->
<!--		var latStop;-->
<!--		var lonStop;-->
<!--		map.on('contextmenu', function(e) {-->
<!--			if (markerStop == null) {-->
<!--				markerStop = L.marker(e.latlng);-->
<!--				markerStop.addTo(map);-->
<!--			} else {-->
<!--				markerStop.setLatLng(e.latlng);-->
<!--			};-->
<!--		latStop = markerStop.getLatLng().lat;-->
<!--		lonStop = markerStop.getLatLng().lng;-->
<!--		computeRoute()-->
<!--		});-->
		
		var markerStart = null;
		var latStart;
		var lonStart;
		var markerStop = null;
		var latStop;
		var lonStop;
		map.on('contextmenu', function(e) {
    		$.contextMenu({
       	        selector: '#map',
            	callback: function(key, options) {
				    console.log('e.latlng=' + e.latlng)
		     		if (key == "start") {
			     		if (markerStart == null) {
						    markerStart = L.marker(e.latlng, {draggable:true});
						    markerStart.addTo(map);
					    } else {
						    markerStart.setLatLng(e.latlng);
					    };
					    latStart = markerStart.getLatLng().lat;
					    lonStart = markerStart.getLatLng().lng;
					    console.log("start" + latStart);
					    console.log("start" + lonStart);
					    computeRoute();
		     		} else if (key == "stop") {
		     			if (markerStop == null) {
						    markerStop = L.marker(e.latlng, {draggable:true});
						    markerStop.addTo(map);
					    } else {
						    markerStop.setLatLng(e.latlng);
					    };
					    latStop = markerStop.getLatLng().lat;
					    lonStop = markerStop.getLatLng().lng;
					    console.log("stop" + latStop);
					    console.log("stop" + lonStop);
					    computeRoute();
		     		}
             		$.contextMenu('destroy', '#map');
                },
                items: {
                    "start": {
                        name: "Start position"
                    },
                    "stop": {
            	        name: "Arrival position"
        	        }
            	}
            });
        });
        
		// get the route
		routeLayer = undefined;
		function computeRoute() {
			var ajaxTime= new Date().getTime();
			$.ajax({
				dataType: "json",
				data: {
					lat1: latStart,
					lon1: lonStart,
					lat2: latStop,
					lon2: lonStop,
					type: $('input[name=profile]:checked').val()
				},
				url: '/route.json',
				success: function(route) {
					if (routeLayer != undefined) {
					map.removeLayer(routeLayer);
					}
					$("#routeLength").html("Longueur : " + Math.round(route.properties.length) + " m");
					$("#routeTime").html("Temps : " + Math.round(route.properties.length*3.6/5) + " s");
					routeLayer = L.geoJson(route);
					routeLayer.addTo(map);
			  }
			}).done(function () {
       		    var totalTime = new Date().getTime()-ajaxTime;
       		    $("#responseTime").html("Temps de réponse : " + totalTime+ " ms");
		    })
		};
	</script>
</body>
</html>

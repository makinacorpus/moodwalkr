<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<title>Routing</title>
	 <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
	 <link rel="stylesheet" href="http://medialize.github.com/jQuery-contextMenu/src/jquery.contextMenu.css" />
	 <link rel="stylesheet" href="css/bootstrap.css" media="screen">
	 <link rel="stylesheet" href="css/main.css">
	<!--[if lte IE 8]>
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css" />
	<![endif]-->
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
	<script src="http://medialize.github.com/jQuery-contextMenu/src/jquery.ui.position.js"></script>
	<script src="http://medialize.github.com/jQuery-contextMenu/src/jquery.contextMenu.js"></script>
	<script src="js/bootstrap.min.js"></script>
</head>

<body>
	<!-- Add Leaflet library -->
	<div class="row-fluid">
	    <div class="span12" id="map" style="height:600px;" ></div>
	    <div class="span3" id="action">
	        <form>
              <fieldset>
                <input style='width:90%' type="text" id="startField" placeholder="Start"><br />
                <input style='width:90%' type="text" id="destinationField" placeholder="Destination">
              </fieldset>
            </form>
        </div>
	    <div id="routeLength"></div>
	    <div id="routeTime"></div>
	    <div id="responseTime"></div>
	</div>
	<script type='text/javascript'>
		map = new L.Map('map', {zoomControl:false});
		// create the tile layer with correct attribution
		var osmUrl='http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png';
		var osmAttrib='Carte <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png"> Données <a href="http://www.openstreetmap.org/copyright">© Contributeurs OpenStreetMap</a>';
		var subDomains = ['otile1','otile2','otile3','otile4'];
		var osm = new L.TileLayer(osmUrl, {minZoom: 3, maxZoom: 18, attribution: osmAttrib, subdomains: subDomains});	

		// Don't show the 'Powered by Leaflet' text	
		map.attributionControl.setPrefix('');
		
		// Zoom buttons position
		var zoomp = new L.Control.Zoom({position: 'topright'});
        zoomp.addTo(map);
        
		// Start the map in Toulouse
		map.addLayer(osm);
		map.setView(new L.LatLng(43.6, 1.4),12);
		
		// Route style
		var routeStyles = {
		    "length":  {
                "color": "red",
                "weight": 5,
                "opacity": 0.5,
                "clickable": false
            },
            "cost_activity" : {
                "color": "blue",
                "weight": 5,
                "opacity": 0.5,
                "clickable": false
            },
            "cost_nature": {
                "color": "green",
                "weight": 5,
                "opacity": 0.5,
                "clickable": false
            }
        };
		
		// Layers
		var routeLayers = {
		    "length": "routeShortestLayer",
            "cost_activity": "routeActivityLayer",
            "cost_nature": "routeNatureLayer"
        };
        		

        // Markers
        var markersList = {
            "start": {
                "marker": null,
                "lat": null,
                "lon": null
            },
            "stop": {
                "marker": null,
                "lat": null,
                "lon": null
            }
        };
        
		routeShortestLayer = undefined;
		routeActivityLayer = undefined;
		routeNatureLayer = undefined;

		// Set start and stop markers
	    function setMarker(marker,latlng) {
		    if (markersList[marker]["marker"] == null) {
		        markersList[marker]["marker"] = L.marker(latlng, {draggable:true});
		        markersList[marker]["marker"].addTo(map);
	        } else {
		        markersList[marker]["marker"].setLatLng(latlng);
	        };
	        markersList[marker]["lat"] = markersList[marker]["marker"].getLatLng().lat;
	        markersList[marker]["lon"] = markersList[marker]["marker"].getLatLng().lng;
	        computeRoute("length");
	        computeRoute("cost_activity");
	        computeRoute("cost_nature");
	    };
	    
		// Set the start and end points

		map.on('contextmenu', function(e) {
    		$.contextMenu({
       	        selector: '#map',
            	callback: function(key, options) {
				    setMarker(key,e.latlng);
             		$.contextMenu('destroy', '#map');
                },
                items: {
                    "start": {
                        name: "Start"
                    },
                    "stop": {
            	        name: "Destination"
        	        }
            	}
            });
        });
        
		// get the route
		function computeRoute(profile) {
		    if ((markersList["start"]["marker"] != null) && (markersList["stop"]["marker"] != null)) {
			    var ajaxTime= new Date().getTime();
			    $.ajax({
				    dataType: "json",
				    data: {
					    lat1: markersList["start"]["lat"],
					    lon1: markersList["start"]["lon"],
					    lat2: markersList["stop"]["lat"],
					    lon2: markersList["stop"]["lon"],
					    type: profile
				    },
				    url: '/route.json',
				    success: function(route) {
					    $("#routeLength").html("Longueur : " + Math.round(route.properties.length) + " m");
					    $("#routeTime").html("Temps : " + Math.round(route.properties.length*3.6/5) + " s");
					    console.log(route.properties.profile);
			                if (routeLayers[route.properties.profile] != undefined) {
			                    map.removeLayer(routeLayers[route.properties.profile]);
			                }
			                console.log("in case length");
			                routeLayers[route.properties.profile] = L.geoJson(route, {style: routeStyles[route.properties.profile]});
			                routeLayers[route.properties.profile].addTo(map);
			      }
			    }).done(function () {
           		    var totalTime = new Date().getTime()-ajaxTime;
           		    $("#responseTime").html("Temps de réponse : " + totalTime+ " ms");
				    document.getElementById('action').style.height="200px";
		        })
		    }
		};
		
		// 
		$("#startField").keyup(function (e) {
            if (e.keyCode == 13) {
                $.getJSON("http://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + document.getElementById('startField').value, function(data) {
                    $.each(data, function(key, val) {
                        setMarker("start",new L.LatLng(val['lat'], val['lon']));
                    });
                }); 
            }
        });
        
		$("#destinationField").keyup(function (e) {
            if (e.keyCode == 13) {
                $.getJSON("http://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + document.getElementById('destinationField').value, function(data) {
                    console.log(data);
                    $.each(data, function(key, val) {
                        setMarker("stop",new L.LatLng(val['lat'], val['lon']));
                    });
                }); 
            }
        });
	</script>
</body>
</html>
